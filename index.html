<html>
	<head>
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <style>
            #board {
                background-color: #ccc;
                border: 4px solid #bbb;
                width: 400px;
                overflow: auto;
            }
            #board div {
                background-color: #fff;
                width: 90px;
                height: 90px;
                float: left;
                margin: 5px 5px;
                text-align: center;
                font-size: 40px;
                font-weight: bold;
                font-family: Arial, sans;
                line-height: 90px;
            }
            #board div.item {
                position: relative;
                background-color: #ff0;
                margin: 0;
            }
            textarea {
                font-size: 32px;
            }
        </style>
	</head>
	<body>
		<div id="board"></div>
        <textarea rows="5" cols="8"></textarea>        
		<script>
            var KSH = {};

            // Config
            KSH.w = 4;
            KSH.h = 4;
            KSH.len = 90;
            KSH.container = '#board';
            KSH.update = false;

            // Methods
            KSH.createMatrix = function() {
                KSH.matrix = new Array(KSH.w);

                for (i = 0; i < KSH.w; ++i) {
                    KSH.matrix[i] = new Array(KSH.h);

                    for (j = 0; j < KSH.h; ++j) {
                        KSH.matrix[i][j] = 0;
                    }
                }
            };

            KSH.drawMatrix = function() {
                var str = '';

                for (j = 0; j < KSH.h; ++j) {
                    for (i = 0; i < KSH.w; ++i) {
                        str = str + KSH.matrix[i][j] + ' ';
                    }

                    str = str + '\n';
                }

                $('textarea').html(str);
            };

            KSH.isFull = function() {
                for (j = 0; j < KSH.h; ++j) {
                    for (i = 0; i < KSH.w; ++i) {
                        if (KSH.matrix[i][j] == 0) {
                            return false;
                        }
                    }
                }

                return true;
            };

            KSH.generate = function() {
                if (KSH.isFull()) {
                    console.log('we are full');
                    return false;
                }

                var item = Math.round(Math.random() * 2) + 1;
                var x = Math.round(Math.random() * (KSH.w - 1));
                var y = Math.round(Math.random() * (KSH.h - 1));

                if (KSH.matrix[x][y] != 0) {
                    console.log('crap');
                    KSH.generate();
                } else {
                    KSH.matrix[x][y] = item;
                }

                return true;
            };

            KSH.up = function() {
                for (j = 0; j < KSH.h; ++j) {
                    for (i = 0; i < KSH.w; ++i) {
                        if (KSH.matrix[i][j] != 0) {
                            var dj = j - 1;

                            while (dj >= 0 && KSH.matrix[i][dj] == 0) {
                                dj--;
                            }

                            // Movement
                            dj++;

                            if (dj != j) {
                                KSH.matrix[i][dj] = KSH.matrix[i][j];
                                KSH.matrix[i][j] = 0;
                                KSH.update = true;
                            }
                        }
                    }
                }
            };
            KSH.down = function() {
                for (j = KSH.h - 1; j >= 0; --j) {
                    for (i = 0; i < KSH.w; ++i) {
                        if (KSH.matrix[i][j] != 0) {
                            var dj = j + 1;

                            while (dj < KSH.h && KSH.matrix[i][dj] == 0) {
                                dj++;
                            }

                            // Movement
                            dj--;

                            if (dj != j) {
                                KSH.matrix[i][dj] = KSH.matrix[i][j];
                                KSH.matrix[i][j] = 0;
                                KSH.update = true;
                            }
                        }
                    }
                }
            };
            KSH.left = function() {
                for (i = 0; i < KSH.w; ++i) {
                    for (j = 0; j < KSH.h; ++j) {
                        if (KSH.matrix[i][j] != 0) {
                            var di = i - 1;

                            while (di >= 0 && KSH.matrix[di][j] == 0) {
                                di--;
                            }

                            // Movement
                            di++;

                            if (di != i) {
                                KSH.matrix[di][j] = KSH.matrix[i][j];
                                KSH.matrix[i][j] = 0;
                                KSH.update = true;
                            }
                        }
                    }
                }
            };
            KSH.right = function() {
                for (i = KSH.w - 1; i >= 0; --i) {
                    for (j = 0; j < KSH.h; ++j) {
                        if (KSH.matrix[i][j] != 0) {
                            var di = i + 1;

                            while (di < KSH.w && KSH.matrix[di][j] == 0) {
                                di++;
                            }

                            // Movement
                            di--;

                            if (di != i) {
                                KSH.matrix[di][j] = KSH.matrix[i][j];
                                KSH.matrix[i][j] = 0;
                                KSH.update = true;
                            }
                        }
                    }
                }
            };

            // Begin
            KSH.createMatrix();
            KSH.generate();
            KSH.drawMatrix();

            $('body').on('keyup', function(ev) {
                switch(ev.keyCode) {
                    case 38:
                        KSH.up();
                        break;
                    case 40:
                        KSH.down();
                        break;
                    case 37:
                        KSH.left();
                        break;
                    case 39:
                        KSH.right();
                        break;
                }

                if (KSH.update) {
                    console.log('updating');
                    KSH.update = false;
                    KSH.generate();
                    KSH.drawMatrix();
                }
            });
		</script>
	</body>
</html>
